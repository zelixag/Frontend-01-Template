### js引擎和宿主环境的关系

1. 当拿到一段js代码时，宿主环境会把代码传递给javascript引擎，并且执行
2. 此外，宿主环境还会提供api给js引擎，比如settimeout这样的api
3. ES3 js还不能异步执行代码的能力，js引擎只会把代码一次顺序执行，这个任务是是宿主发起的任务
4. ES5 js引入了Promise，这样，js本身就能发起任务
5. 宿主发起任务是宏任务， js引擎的是微任务

### 宏任务 和 微任务
 宏任务队列相当于事件循环
## 消息队列和事件循环
- 每个渲染进程都有一个主线程，很忙
  - 既要处理DOM，
  - 又要计算样式，
  - 还要处理布局
  - 同时处理JavaScript任务以及各种输入事件

思考： 为了让这么多不同类型的任务在主线程中有条不紊的执行，，需要一个系统来统筹这些任务

**统筹调度系统就是-消息队列和事件循环系统-**

了解事件循环非常底层且非常重要，学会它能让你理解页面到低是如何运行的。
把好几个任务放到线程里逐个执行，执行完之后线程退出
![任务入线程](https://static001.geekbang.org/resource/image/72/bc/72726678ac6604116c1d5dad160780bc.png)
如果在这时候又来了个新任务执行，就无法处理这个情况了。要想在线程运行过程中，能接收并执行新的任务，就需要采用事件循环机制。

第一点引入了循环机制，这样就可以线程会一直循环执行

第二点是引入了事件，事件触发线程运行

通过引入事件循环机制，就可以让线程活起来了，我们每次输入两个数字，都会打印出两个数字相加的结果，如图
![事件循环机制](https://static001.geekbang.org/resource/image/9e/e3/9e0f595324fbd5b7cd1c1ae1140f7de3.png)

### 构造事件循环系统

有了堆空间和栈空间，生成全局执行上下文和全局作用域，接下来还是不能执行js代码

V8还需要一个主线程，用来执行js和执行垃圾回收等工作。V8都是依靠宿主提供主线程，V8所执行代码都是宿主的主线程执行的

js是单线程的，如果执行一段代码，执行完之后自动退出，数据也随之销毁，需要重新启动一个线程重新初始化栈数据，这会严重影响到程序执行的性能。
为了执行代码之后，让线程继续运行，通常做法是在代码中添加一个循环语句，在循环语句中监听下个事件，那么激活该循环就可以执行了。

这个就是V8引入了一个消息队列，让下载完成的事件暂存到消息队列中，等当前任务执行结束之后，再从消息队列中取出正在排队的任务。事件循环系统循环这个过程。

所有的任务（宏任务和微任务）都是运行在主线程的，在浏览器中，V8会和页面共用主线程，共用消息队列，如果V8有一个函数执行太久
会影响到浏览器页面的交互性能